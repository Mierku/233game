# 虚拟列表调试指南

## 🔧 调试工具

### 1. 自动调试信息

在开发环境下，虚拟列表会每 20 次计算输出一次详细的调试信息：

```
🔍 虚拟列表调试: {
  滚动位置: 1250,
  可视区域: "950 ~ 1550",
  找到可视卡片: 8,
  跳过未计算卡片: 2,
  总检查卡片: 50,
  缓存位置数量: 48,
  总卡片数量: 50
}

📋 可视区域卡片详情 (共8张)
  卡片 5: {
    标题: "示例标题...",
    位置: "(0, 1200)",
    实际高度: 320,
    预估高度: 315,
    高度差异: 5,
    可视区域内: "1200 ~ 1520",
    是否在范围: "顶部✓ 底部✓"
  }
```

### 2. 手动调试函数

#### `window.debugVirtualList()`

在浏览器控制台调用，获取完整的虚拟列表状态分析：

```javascript
// 在控制台执行
window.debugVirtualList();
```

输出内容包括：

- **基础信息**：滚动位置、可视区域、缓存状态
- **可见卡片**：正常显示的卡片列表
- **应该可见但未显示**：虚拟列表 bug 的关键信息
- **位置未计算**：还未计算位置的卡片
- **高度未测量**：还未测量实际高度的卡片
- **列高度信息**：瀑布流布局状态

#### `window.quickDebug()`

快速查看当前状态，输出简化信息：

```javascript
// 在控制台执行
window.quickDebug();

// 或使用键盘快捷键
Ctrl + Shift + D;
```

## 🐛 常见问题诊断

### 问题 1：可视卡片越来越少

**症状**：向下滚动时，显示的卡片数量逐渐减少

**诊断步骤**：

1. 执行 `window.debugVirtualList()`
2. 查看 "应该可见但未显示" 部分
3. 检查这些卡片的位置和高度信息

**可能原因**：

- 卡片位置计算错误
- 高度预估与实际差异过大
- 虚拟列表可视区域计算有误

### 问题 2：卡片位置跳动

**症状**：滚动时卡片位置突然改变

**诊断步骤**：

1. 观察控制台的高度差异信息
2. 查看 "高度未测量" 的卡片数量
3. 检查列高度是否平衡

**可能原因**：

- 图片加载完成后高度变化
- 预估高度算法不准确
- 列高度重新计算触发位置调整

### 问题 3：卡片重复或缺失

**症状**：某些卡片重复显示或完全不显示

**诊断步骤**：

1. 检查 "缓存位置数量" 是否正常
2. 查看 "位置未计算" 的卡片
3. 对比总卡片数与实际数据

**可能原因**：

- 卡片索引计算错误
- 位置缓存被意外清除
- 数据更新时缓存未同步

## 📊 性能监控

### 虚拟列表性能统计

每 10 次计算输出性能信息：

```
虚拟列表性能统计: {
  可视卡片数量: 8,
  总卡片数量: 50,
  计算耗时: "2.30ms",
  平均耗时: "1.85ms",
  计算次数: 120
}
```

**性能指标说明**：

- **计算耗时**：单次虚拟列表计算时间，应 < 5ms
- **平均耗时**：历史平均计算时间
- **计算次数**：总计算次数，可判断是否过于频繁

## 🔍 调试技巧

### 1. 实时监控

在滚动过程中持续观察控制台输出，关注：

- 可视卡片数量变化趋势
- 缺失卡片的索引范围
- 高度差异的分布情况

### 2. 断点调试

在以下函数设置断点进行深入调试：

- `calculateVisibleCards()` - 虚拟列表核心计算
- `calculateCardPosition()` - 卡片位置计算
- `getEstimatedCardHeight()` - 高度预估

### 3. 数据对比

对比以下数据的一致性：

- `displayCards.value.length` - 总数据量
- `cardPositionsCache.value.filter(p => p).length` - 已计算位置数量
- `visibleCardsCache.value.length` - 当前可视数量

## 🛠️ 修复建议

### 高度预估优化

如果高度差异过大（>20px），考虑：

1. 调整 `getEstimatedCardHeight` 中的计算参数
2. 优化字体宽度估算（`avgCharWidth`）
3. 检查 CSS 样式是否与预估一致

### 虚拟列表优化

如果可视卡片数量异常，考虑：

1. 调整缓冲区高度（`bufferHeight`）
2. 优化滚动触发阈值
3. 检查可视区域计算逻辑

### 性能优化

如果计算耗时过长，考虑：

1. 减少调试信息输出频率
2. 优化循环逻辑
3. 增加 RAF 节流控制

## 📝 调试日志示例

```javascript
// 正常状态
🚀 快速调试 [14:30:25] {
  滚动: 800,
  可视区域: "500 ~ 1100",
  显示卡片: 6,
  总卡片: 20,
  缓存位置: 20,
  缓存高度: 18,
  列高度: [1200, 1180, 1190]
}

// 异常状态 - 可视卡片过少
🚀 快速调试 [14:30:30] {
  滚动: 1200,
  可视区域: "900 ~ 1500",
  显示卡片: 2, // ⚠️ 异常：应该有更多卡片
  总卡片: 20,
  缓存位置: 15, // ⚠️ 部分位置未计算
  缓存高度: 12,
  列高度: [1800, 1650, 1720]
}
```

通过这些调试工具，可以快速定位虚拟列表的问题并进行针对性修复。
